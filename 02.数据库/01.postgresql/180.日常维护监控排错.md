---
title: 日常维护监控排错
date: 2022-09-15 21:01:17
permalink: /pages/d4299f/
categories:
  - 数据库
  - postgresql
tags:
  - 
---
# 日常维护监控排错

## 数据库审计

![image-20220913221350917](./image/image-20220913221350917.png)

## 索引维护

索引膨胀之后不容易缩，采取重建索引的方式

![image-20220913221607964](./image/image-20220913221607964.png)

![image-20220913221657891](./image/image-20220913221657891.png)

## 在线回收空间

![image-20220913221720804](./image/image-20220913221720804.png)

## 在线加列

10以后的版本还是需要设置超时

![image-20220913221835192](./image/image-20220913221835192.png)



## 清理wal日志（就是redo）

删除之后会导致数据库起不来

![image-20220913222032709](./image/image-20220913222032709.png)

![image-20220913222234020](./image/image-20220913222234020.png)

## 清理审计日志

![image-20220913222425403](./image/image-20220913222425403.png)

## 进程维护

![image-20220913222443316](./image/image-20220913222443316.png)

## 序列耗尽

![image-20220913222724448](./image/image-20220913222724448.png)

## 审计日志分析

![image-20220913222812126](./image/image-20220913222812126.png)

用pgBadger去分析

![image-20220913222705329](./image/image-20220913222705329.png)

## freeze预测与解决



## 大表分区

分区方法：pg_pathman 和pg12之后内置分区

![image-20220913222944750](./image/image-20220913222944750.png)

## 冷热分离存储

![image-20220913223252686](./image/image-20220913223252686.png)

## 清理未使用对象，表索引

![image-20220913223506910](./image/image-20220913223506910.png)

## 长事务的清理

![image-20220913223523002](./image/image-20220913223523002.png)

```sql
postgres=# show restart_after_crash ;
 restart_after_crash 
---------------------
 on
(1 row)
```

不能kill ，上面这个配置之后才会自动拉起

## 锁等待清理

![image-20220913223859497](./image/image-20220913223859497.png)

## 小版本升级

![image-20220913223923405](./image/image-20220913223923405.png)

有可能需要重建索引

## 大版本升级

![image-20220914130708180](./image/image-20220914130708180.png)

![image-20220914130836788](./image/image-20220914130836788.png)

## 监控

![image-20220914130902123](./image/image-20220914130902123.png)

锁等待，长事务，数据库年龄，活跃会话



![image-20220914131052551](./image/image-20220914131052551.png)

## 优化



![image-20220914131203006](./image/image-20220914131203006.png)![image-20220914131219666](./image/image-20220914131219666.png)

![image-20220914131540692](./image/image-20220914131540692.png)

## TOP sql



![image-20220914131604073](./image/image-20220914131604073.png)

![image-20220914131656450](./image/image-20220914131656450.png)

![image-20220914131711676](./image/image-20220914131711676.png)

![image-20220914131722965](./image/image-20220914131722965.png)

![image-20220914131740660](./image/image-20220914131740660.png)

![image-20220914131831231](./image/image-20220914131831231.png)

![image-20220914131844591](./image/image-20220914131844591.png)



![image-20220914132045019](./image/image-20220914132045019.png)

![image-20220914131931306](./image/image-20220914131931306.png)

![image-20220914132144981](./image/image-20220914132144981.png)

![image-20220914132207976](./image/image-20220914132207976.png)

![image-20220914132215241](./image/image-20220914132215241.png)

![image-20220914132223988](./image/image-20220914132223988.png)

![image-20220914132230488](./image/image-20220914132230488.png)

![image-20220914132240603](./image/image-20220914132240603.png)

![image-20220914132253855](./image/image-20220914132253855.png)

![image-20220914132302808](./image/image-20220914132302808.png)

![image-20220914132311231](./image/image-20220914132311231.png)

![image-20220914132340752](./image/image-20220914132340752.png)

![image-20220914132357240](./image/image-20220914132357240.png)



![image-20220914132410841](./image/image-20220914132410841.png)

![image-20220914132427833](./image/image-20220914132427833.png)

![image-20220914132442050](./image/image-20220914132442050.png)

![image-20220914132512387](./image/image-20220914132512387.png)

![image-20220914132518808](./image/image-20220914132518808.png)

![image-20220914132527007](./image/image-20220914132527007.png)

![image-20220914132532785](./image/image-20220914132532785.png)

![image-20220914132539393](./image/image-20220914132539393.png)

![image-20220914132603667](./image/image-20220914132603667.png)

![image-20220914132631064](./image/image-20220914132631064.png)

![image-20220914132643249](./image/image-20220914132643249.png)

![image-20220914132724137](./image/image-20220914132724137.png)

![image-20220914132735788](./image/image-20220914132735788.png)

优化，没有加索引，没有加对索引

什么情况下推荐索引：

扫描大量记录，返回的数量少的；

通过数据库统计信息

seq_scan和seq_tup_read

![image-20220914133016377](./image/image-20220914133016377.png)

![image-20220914133231146](./image/image-20220914133231146.png)

![image-20220914133420399](./image/image-20220914133420399.png)

![image-20220914133448065](./image/image-20220914133448065.png)

![image-20220914133522453](./image/image-20220914133522453.png)

![image-20220914133643454](./image/image-20220914133643454.png)![image-20220914133702361](./image/image-20220914133702361.png)

![image-20220914133737753](./image/image-20220914133737753.png)

![image-20220914133752048](./image/image-20220914133752048.png)

![image-20220914133813106](./image/image-20220914133813106.png)

![image-20220914133839125](./image/image-20220914133839125.png)

![image-20220914133901390](./image/image-20220914133901390.png)

![image-20220914133917406](./image/image-20220914133917406.png)

![image-20220914133946539](./image/image-20220914133946539.png)

![image-20220914134151040](./image/image-20220914134151040.png)

![image-20220914134219250](./image/image-20220914134219250.png)

![image-20220914134232457](./image/image-20220914134232457.png)

## 上报错误

![image-20220914134301309](./image/image-20220914134301309.png)

![image-20220914134338997](./image/image-20220914134338997.png)

当前会话对应进程

![image-20220914134420756](./image/image-20220914134420756.png)



## 异常问题上报

![image-20220914134548864](./image/image-20220914134548864.png)

