<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PG基础问题及处理方法 | YAO blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="记录">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,yunwei前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.dddda837.css" as="style"><link rel="preload" href="/assets/js/app.be07e937.js" as="script"><link rel="preload" href="/assets/js/2.421bd99f.js" as="script"><link rel="preload" href="/assets/js/3.52061743.js" as="script"><link rel="preload" href="/assets/js/23.b75d31d7.js" as="script"><link rel="prefetch" href="/assets/js/10.bdb6d1df.js"><link rel="prefetch" href="/assets/js/11.615c51b0.js"><link rel="prefetch" href="/assets/js/12.54505169.js"><link rel="prefetch" href="/assets/js/13.fdd94bce.js"><link rel="prefetch" href="/assets/js/14.3314f54e.js"><link rel="prefetch" href="/assets/js/15.7a6c77ad.js"><link rel="prefetch" href="/assets/js/16.76f1435c.js"><link rel="prefetch" href="/assets/js/17.ba5b8687.js"><link rel="prefetch" href="/assets/js/18.5171850c.js"><link rel="prefetch" href="/assets/js/19.ac2e6c51.js"><link rel="prefetch" href="/assets/js/20.f7933fd3.js"><link rel="prefetch" href="/assets/js/21.605175f5.js"><link rel="prefetch" href="/assets/js/22.746f4db9.js"><link rel="prefetch" href="/assets/js/24.90f0aa42.js"><link rel="prefetch" href="/assets/js/25.747b84a2.js"><link rel="prefetch" href="/assets/js/26.1d3a1b30.js"><link rel="prefetch" href="/assets/js/27.48423a74.js"><link rel="prefetch" href="/assets/js/28.32ce2030.js"><link rel="prefetch" href="/assets/js/29.62c3fb02.js"><link rel="prefetch" href="/assets/js/30.50f5d92a.js"><link rel="prefetch" href="/assets/js/31.25c3816f.js"><link rel="prefetch" href="/assets/js/32.20ea6271.js"><link rel="prefetch" href="/assets/js/33.7ebbec06.js"><link rel="prefetch" href="/assets/js/34.c8b7ffdc.js"><link rel="prefetch" href="/assets/js/35.597173e8.js"><link rel="prefetch" href="/assets/js/36.715ea195.js"><link rel="prefetch" href="/assets/js/37.9a3b216b.js"><link rel="prefetch" href="/assets/js/38.6a473cc4.js"><link rel="prefetch" href="/assets/js/4.6f0d2b14.js"><link rel="prefetch" href="/assets/js/5.53009c97.js"><link rel="prefetch" href="/assets/js/6.7a27b3fd.js"><link rel="prefetch" href="/assets/js/7.c07a8c53.js"><link rel="prefetch" href="/assets/js/8.50367d96.js"><link rel="prefetch" href="/assets/js/9.18ef63f1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dddda837.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="YAO blog" class="logo"> <span class="site-name can-hide">YAO blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/shujuku/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>传统数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/ee767f/" class="nav-link">postgresql</a></li><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">mysql</a></li><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">oracle</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/sql/" class="nav-link">《sql编程》</a></li><li class="dropdown-subitem"><a href="/note/dashuju/" class="nav-link">《大数据》</a></li><li class="dropdown-subitem"><a href="/note/postgresql/" class="nav-link">《postgresql》</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维专项" class="dropdown-title"><a href="/yunwei/" class="link-title">运维专项</a> <span class="title" style="display:none;">运维专项</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/331efa/" class="nav-link">Docker&amp;k8s</a></li><li class="dropdown-item"><!----> <a href="/pages/0d801d/" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/pages/48e74d/" class="nav-link">监控</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/biancheng/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/74c26a/" class="nav-link">python</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">java</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">shell</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">C/C++/GO</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">前端</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="梦工厂" class="dropdown-title"><a href="/dream/" class="link-title">梦工厂</a> <span class="title" style="display:none;">梦工厂</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/115b2f/" class="nav-link">树莓派</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">Stm32/arduino</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">人工智能</a></li></ul></div></div><div class="nav-item"><a href="/guanyu/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/494c74/" class="nav-link">一个人的世界观</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fc-ssl.duitang.com%2Fuploads%2Fitem%2F201906%2F26%2F20190626161203_vsahm.jpg&amp;refer=http%3A%2F%2Fc-ssl.duitang.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1652060957&amp;t=f875dc5ba813758f973675007c317789"> <div class="blogger-info"><h3>luoyao</h3> <span>不积跬步 无以至千里</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/shujuku/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>传统数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/ee767f/" class="nav-link">postgresql</a></li><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">mysql</a></li><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">oracle</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/sql/" class="nav-link">《sql编程》</a></li><li class="dropdown-subitem"><a href="/note/dashuju/" class="nav-link">《大数据》</a></li><li class="dropdown-subitem"><a href="/note/postgresql/" class="nav-link">《postgresql》</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维专项" class="dropdown-title"><a href="/yunwei/" class="link-title">运维专项</a> <span class="title" style="display:none;">运维专项</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/331efa/" class="nav-link">Docker&amp;k8s</a></li><li class="dropdown-item"><!----> <a href="/pages/0d801d/" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/pages/48e74d/" class="nav-link">监控</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/biancheng/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/74c26a/" class="nav-link">python</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">java</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">shell</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">C/C++/GO</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">前端</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="梦工厂" class="dropdown-title"><a href="/dream/" class="link-title">梦工厂</a> <span class="title" style="display:none;">梦工厂</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/115b2f/" class="nav-link">树莓派</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">Stm32/arduino</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">人工智能</a></li></ul></div></div><div class="nav-item"><a href="/guanyu/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/494c74/" class="nav-link">一个人的世界观</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>postgresql</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ee767f/" class="sidebar-link">创建用户并且授权流程</a></li><li><a href="/pages/1d6465/" class="sidebar-link">postgresql原理</a></li><li><a href="/pages/dbb18f/" class="sidebar-link">查找消耗高SQL以及SQL优化</a></li><li><a href="/pages/6c04cf/" aria-current="page" class="active sidebar-link">PG基础问题及处理方法</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>oracle</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习笔记</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-5add8e0a><div class="articleInfo" data-v-5add8e0a><ul class="breadcrumbs" data-v-5add8e0a><li data-v-5add8e0a><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-5add8e0a></a></li> <li data-v-5add8e0a><a href="/shujuku/#数据库" data-v-5add8e0a>数据库</a></li><li data-v-5add8e0a><a href="/shujuku/#postgresql" data-v-5add8e0a>postgresql</a></li></ul> <div class="info" data-v-5add8e0a><div title="作者" class="author iconfont icon-touxiang" data-v-5add8e0a><a href="javascript:;" data-v-5add8e0a>luoyao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-5add8e0a><a href="javascript:;" data-v-5add8e0a>2022-04-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><!----> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">PG基础问题及处理方法<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="pg基础问题及处理方法"><a href="#pg基础问题及处理方法" class="header-anchor">#</a> PG基础问题及处理方法</h1> <h1 id="_1、pg中如何判断-idle-in-transaction-为僵尸事务"><a href="#_1、pg中如何判断-idle-in-transaction-为僵尸事务" class="header-anchor">#</a> 1、PG中如何判断 idle in transaction 为僵尸事务</h1> <p>backend_xid：用来表示会话是否申请了事务号</p> <p>backend_xmin：事务会话的快照ID</p> <p>如果backend_xid 和 backend_xmin 为空，可清理掉该进程， 如果不为空，说明事务还没结束，如未提交</p> <h1 id="_2、查看当前事务"><a href="#_2、查看当前事务" class="header-anchor">#</a> 2、查看当前事务</h1> <p>select txid_current();</p> <h1 id="_3、pg等待事件根因分析表"><a href="#_3、pg等待事件根因分析表" class="header-anchor">#</a> 3、PG等待事件根因分析表</h1> <p>https://pgfans.cn/a/1654</p> <h1 id="_4、autovacuum优化的小技巧"><a href="#_4、autovacuum优化的小技巧" class="header-anchor">#</a> 4、AUTOVACUUM优化的小技巧</h1> <p>三个基本参数：
autovacuum_max_workers：</p> <p>工作进程数数量默认为3，增加 autovacuum worker的数量意味着更多的进程可用于清理数据，通常应该将worker的数量设置为3-cpu_count之间最先设置为CPU_COUNT的1/2吧，如果在系统高峰期，CPU资源出现了瓶颈，那么适当缩小该值，如果CPU资源还很充足，但是autovacuum的性能不足，那么就增加这个值。</p> <p>maintenance_work_mem：</p> <p>值越大，vacuum的效率越高，设置的太大耗尽了内存，会产生严重的性能问题</p> <p>物理内存充足，建议maintenance_work_mem至少设置为 1 GB</p> <p>1 GB的维护工作内存足以一次处理大约 1.79 亿个死元组</p> <p>autovacuum_freeze_max_age：</p> <p>减少 TXID 回绕的机会，越大，autovacuum运行的频率就越低，延迟太久会消耗txid编号</p> <p><strong>对表级别进行设置：</strong></p> <p>这些参数属于表的storage参数。通过ALTER TABLE .. SET STORAGE_PARAMETER可以进行个性化的设置。</p> <p>autovacuum_vacuum_threshol，autovacuum_analyze_threshol</p> <p>这两个参数分别确定要为 autovacuum 和 autoanalyzer 表中从上一次vacuum后更新或删除的记录数的最小数量。两者的默认值都是 50</p> <p>autovacuum_vacuum_scale_factor</p> <p>autovacuum_analyze_scale_factor</p> <p>分别确定要为 autovacuum 和 autoanalyzer 安排的表需要更改的表的百分比</p> <p>autovacuum_vacuum_scale_factor值为 0.2 (20%) 和autovacuum_analyze_scale_factor 0.1 (10%)。</p> <p>针对大量行超级大表</p> <p>vacuum threshold = autovacuum_vacuum_threshold + autovacuum_vacuum_scale_factor * n_live_tup</p> <p>其中n_live_tup是活动元组的数量，这个值可以从pg_stat_all_tables视图获得。一旦死元组的数量达到了这个限额，那么就可以启动vacuum作业。</p> <h1 id="_5、逻辑备份pg-dump"><a href="#_5、逻辑备份pg-dump" class="header-anchor">#</a> 5、逻辑备份pg_dump</h1> <p>特点：</p> <p>即使数据库正在被并发使用，它也能创建一致的备份。</p> <p>不阻塞其他用户访问数据库（读取或写入）</p> <p>只能备份单个数据库，不会导出角色和表空间相关的信息</p> <p>生产环境建议方式</p> <p>\1. -F c 备份为二进制格式, 压缩存储. 并且可被pg_restore用于精细还原，输出输入 IO 比较稳定</p> <p>二进制文件备份</p> <p>\1. pg_dump -F c -f /tmp/testdb.dmp -C -EUTF8 -h 127.0.0.1 -U postgres testdb</p> <p>另外可以</p> <p>\1. 1）根据二进制备份文件生成toc文件</p> <p>\2. pg_restore -l -f /tmp/toc1 /tmp/testdb.dmp</p> <p>\3. 2）修改 toc文件，以首行加分号“；”的方式注释掉不用还原的内容</p> <p>\4. vi /tmp/toc1</p> <p>\5. 265; 1259 25280 TABLE public postgres_log postgres</p> <p>\6. 266; 1259 25293 TABLE public t2 postgres</p> <p>并行处理</p> <p>\1. pg_dump -Fd -j4 -f /tmp/db.dir testdb #-F d 以目录的格式创建备份</p> <p>\2. pg_restore -d testdb3 -j4 /tmp/db.dir</p> <p>\3. -j 参数指定同时几个进程来同时执行，每个进程同时只处理一个表的数据。</p> <h1 id="_6、优化方法论"><a href="#_6、优化方法论" class="header-anchor">#</a> 6、优化方法论</h1> <p>了解需求，考虑将需求最小化，具备少做事的意识乃是顶级优化。</p> <h1 id="_7、监控粒度信息"><a href="#_7、监控粒度信息" class="header-anchor">#</a> 7、监控粒度信息</h1> <p>最多的是DataFileWrite，其次是transactionid,再后面是DatafileRead和buffer_mapping。</p> <p>DatafileWrite是等待想relation文件写入</p> <p>DatafileRead是从relation文件读入</p> <p>Transactionid是等待一个事务结束</p> <p>Buffer_mapping是等待将数据块与缓冲池中的缓冲区。这些都是和Benchmark测试关联比较紧密的</p> <p>Extend是等待relation文件扩展结束。这个等待居然比tuple还高</p> <p>tuple是等待获取元组锁。</p> <h1 id="_8、绑定变量的使用问题"><a href="#_8、绑定变量的使用问题" class="header-anchor">#</a> 8、绑定变量的使用问题</h1> <p>优点：让SQL可以共享，可以让一条类似的SQL在多次执行中共享查询执行计划</p> <p>缺点：绑定变量的差异可能选择不同执行计划才好的问题在很多时候都是存在的</p> <h1 id="_9、开启大页"><a href="#_9、开启大页" class="header-anchor">#</a> 9、开启大页</h1> <p>作用：降低系统内存占用</p> <p>优势：</p> <p>1、CPU的TLB可以缓存的物理地址空间更大，从而提升TLB的命中率，降低CPU负载；</p> <p>2、Huge Page使用的内存是不可交换（swap）的，没有内存空间换入/换出的开销；</p> <p>3、极大的减少了系统维护PageTable的内存开销。</p> <p>劣势：</p> <p>1、Huge Page使用的内存需要预先分配；</p> <p>2、Huge Page使用固定大小的内存区域，不会被释放；</p> <p>3、对于写密集型的场景，Huge Page会加大Cache写冲突的发生概率。</p> <p>**使用场景：**不推荐PG实例开启Huge Page的场景：写业务密集，热点数据集中且内存使用较小。</p> <p>计算大页脚本</p> <h1 id="_10、快速加载sql入库的方法"><a href="#_10、快速加载sql入库的方法" class="header-anchor">#</a> 10、快速加载sql入库的方法</h1> <p>查看自动提交是否关闭</p> <p>\echo :AUTOCOMMIT</p> <p>关闭</p> <p>\set AUTOCOMMIT OFF</p> <p>执行插入数据，在文件后加入commit;参数</p> <p>\i /var/lib/pgsql/testdb1.sql</p> <p>以下是测试200w数据</p> <p>只导出insert形式的数据（用copy导入会报错）</p> <p>pg_dump -U postgres -d postgres -p 5432 --column-inserts -t &quot;testdb1&quot; &gt; /var/lib/pgsql/testdb1.sql</p> <p>只导出表结构</p> <p>pg_dump -U postgres -d postgres -p 5432 -s -t &quot;testdb1&quot; &gt; /var/lib/pgsql/testdb1_struct.sql</p> <p>方案一：psql -f 导入，7分钟导入数据量</p> <p><img src="/image/clip_/image002-16466159506211.jpg" alt="img"></p> <p>方案二：\set AUTOCOMMIT OFF，添加</p> <p>导入，5分钟之内能弄完</p> <p>方案三：开启事务</p> <p>begin:</p> <p>\i 执行脚本</p> <p>commit;</p> <p>大页计算脚本和注意事项</p> <p>#!/bin/bash  PGDATA='/pg13/pgdata'  pid=<code>head -1 $PGDATA/postmaster.pid</code>  echo 'Pid: $pid'  peak=<code>grep ^VmPeak /proc/$pid/status | awk '{ print $2 }'</code>  echo 'VmPeak: $peak kB'  hps=<code>grep ^Hugepagesize /proc/meminfo | awk '{ print $2 }'</code>  echo 'Hugepagesize: $hps kB'  hp=$((peak/hps))  echo Set Huge Pages: $hp  sysctl -w vm.nr_hugepages=$hp  不要忘记将此设置添加到/etc/sysctl.conf，以便在重启后重新应用它。  echo 3170 &gt; /proc/sys/vm/nr_hugepages  cat &gt;&gt; /etc/sysctl.conf &lt;&lt;'EOF'  vm.nr_hugepages=3170  EOF  sysctl -p  通过此脚本计算出大页的大小，然后添加到/etc/sysctl.conf里，sysctl -p生效。  参考连接：  https://baijiahao.baidu.com/s?id=1709212963361949625&amp;wfr=spider&amp;for=pc</p> <p>有用知识点</p> <p><a href="https://pgfans.cn/a/1634" target="_blank" rel="noopener noreferrer">PG恢复被打了删除标记的列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>授权某个模式下所有的表和新增的表</p> <p><img src="/image//image-20220329162624551.png" alt="/image-20220329162624551"></p> <h1 id="_11、pg10分区表插入更新无法解决方法"><a href="#_11、pg10分区表插入更新无法解决方法" class="header-anchor">#</a> 11、pg10分区表插入更新无法解决方法</h1> <p>方法1：建立函数</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> f_upsert<span class="token punctuation">(</span><span class="token keyword">integer</span><span class="token punctuation">,</span><span class="token keyword">character</span><span class="token punctuation">,</span><span class="token keyword">timestamp</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> void <span class="token keyword">as</span> $$  
<span class="token keyword">declare</span>  
  res <span class="token keyword">int</span><span class="token punctuation">;</span>  
<span class="token keyword">begin</span>  
  <span class="token keyword">update</span> users <span class="token keyword">set</span> user_name<span class="token operator">=</span>$<span class="token number">2</span><span class="token punctuation">,</span>logdate<span class="token operator">=</span>$<span class="token number">3</span> <span class="token keyword">where</span> user_id<span class="token operator">=</span>$<span class="token number">1</span><span class="token punctuation">;</span>  
  <span class="token keyword">if</span> <span class="token operator">not</span> found <span class="token keyword">then</span>  
    <span class="token keyword">insert</span> <span class="token keyword">into</span> users <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span>user_name<span class="token punctuation">,</span>logdate<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>$<span class="token number">1</span><span class="token punctuation">,</span>$<span class="token number">2</span><span class="token punctuation">,</span>$<span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>  
  exception <span class="token keyword">when</span> others <span class="token keyword">then</span>  
    <span class="token keyword">return</span><span class="token punctuation">;</span>  
<span class="token keyword">end</span><span class="token punctuation">;</span>  
$$ <span class="token keyword">language</span> plpgsql strict<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>方法2：采用with的方式</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">with</span> upsert <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">update</span> users <span class="token keyword">set</span> user_name<span class="token operator">=</span>$user_name<span class="token punctuation">,</span>logdate<span class="token operator">=</span>$logdate <span class="token keyword">where</span> user_id<span class="token operator">=</span>$user_id <span class="token keyword">returning</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> users <span class="token keyword">select</span> $user_id<span class="token punctuation">,</span>$user_name<span class="token punctuation">,</span>$logdate <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> upsert <span class="token keyword">where</span> user_id<span class="token operator">=</span>$user_id<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token keyword">insert</span> <span class="token keyword">into</span> test <span class="token punctuation">(</span>id<span class="token punctuation">,</span>info<span class="token punctuation">,</span>crt_time<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>$<span class="token number">1</span><span class="token punctuation">,</span>$<span class="token number">2</span><span class="token punctuation">,</span>$<span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">with</span> upsert <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">update</span> users <span class="token keyword">set</span> user_name<span class="token operator">=</span><span class="token string">'DD'</span><span class="token punctuation">,</span>logdate<span class="token operator">=</span><span class="token string">'2021-03-21'</span> <span class="token keyword">where</span> user_id<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">returning</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> users <span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">,</span>$user_name<span class="token punctuation">,</span>$logdate <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> upsert <span class="token keyword">where</span> user_id<span class="token operator">=</span>$user_id<span class="token punctuation">)</span><span class="token punctuation">;</span>    


postgres<span class="token operator">=</span><span class="token comment"># select * from users;</span>
 user_id <span class="token operator">|</span> user_name <span class="token operator">|</span>        logdate         
<span class="token comment">---------+-----------+------------------------</span>
       <span class="token number">1</span> <span class="token operator">|</span> AA        <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span><span class="token operator">-</span><span class="token number">05</span>
       <span class="token number">2</span> <span class="token operator">|</span> BB        <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">18</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span><span class="token operator">-</span><span class="token number">05</span>
       <span class="token number">3</span> <span class="token operator">|</span> CC        <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span><span class="token operator">-</span><span class="token number">04</span>
<span class="token punctuation">(</span><span class="token number">3</span> <span class="token keyword">rows</span><span class="token punctuation">)</span>

postgres<span class="token operator">=</span><span class="token comment"># select f_upsert(1,'2','2021-01-18');</span>
postgres<span class="token operator">=</span><span class="token comment"># select * from users;</span>
 user_id <span class="token operator">|</span> user_name <span class="token operator">|</span>        logdate         
<span class="token comment">---------+-----------+------------------------</span>
       <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">18</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span><span class="token operator">-</span><span class="token number">05</span>
       <span class="token number">2</span> <span class="token operator">|</span> BB        <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">18</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span><span class="token operator">-</span><span class="token number">05</span>
       <span class="token number">3</span> <span class="token operator">|</span> CC        <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span><span class="token operator">-</span><span class="token number">04</span>
<span class="token punctuation">(</span><span class="token number">3</span> <span class="token keyword">rows</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h1 id="_12、postgresql中mvcc-表膨胀问题"><a href="#_12、postgresql中mvcc-表膨胀问题" class="header-anchor">#</a> 12、postgresql中mvcc_表膨胀问题</h1> <p>pg中的mvcc
旧版本和新版本在同一个数据库的问题</p> <p>行发生了修改就有新版本和旧版本，存在同样的数据文件里面，如果垃圾回收不及时，就会发生表膨胀</p> <p>技术原理</p> <p>存储旧版本：解决并发事务，方便查询旧的版本数据</p> <p>影响范围，行业，业务</p> <p>对于高频率的更新，插入，删除场景就会有问题</p> <p>传感器，出租车位置，等更新多的场景，容易出问题，垃圾回收不及时，就会膨胀</p> <p>什么时候回收不及时</p> <p>看看有没有2pc</p> <p>看看垃圾回收设置的内存是不是过小</p> <p>垃圾回收工作进程太少了</p> <p>磁盘性能</p> <p>膨胀之后会有什么问题</p> <p>1.存储空间不足</p> <p>2.访问的时候io的范围会增加，本来访问一个数据块的现在需要访问2，3个数据块了</p> <p>3.内存的消耗增加了，因为内存buffer要去缓存block</p> <p>4.性能下降</p> <p>解决：</p> <p>设置参数
https://blog.csdn.net/weixin_34360651/article/details/90504302</p> <p>表膨胀解决方法</p> <p>https://ctypyb2002.blog.csdn.net/article/details/82774684?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.control</p> <p>新引入的问题</p> <p>1、需要io延时更低的硬盘</p> <p>2、牺牲了长事务</p> <p>3、需要增加监控项</p> <p>有没有希望解决这个坑 ：基于专门的回归段的存储引擎</p> <h1 id="_13、postgresql避免oom方法"><a href="#_13、postgresql避免oom方法" class="header-anchor">#</a> 13、postgresql避免oom方法</h1> <p>操作系统层：</p> <p>vm.overcommit_memory设置为2：sysctl -w vm.overcommit_memory=2
修改postgres进程的oom_score：echo -1000 &gt; /proc/self/oom_score_adj</p> <p>参考文章</p> <p>https://weibo.com/ttarticle/p/show?id=2309404665709073662196&amp;sudaref=www.baidu.com</p> <p>https://cdn.modb.pro/db/43944</p> <h1 id="_14、wal记录"><a href="#_14、wal记录" class="header-anchor">#</a> 14、wal记录</h1> <p>数据先到wal buffer--&gt;在落盘保证数据
lsn不断放大的号，确保回放，把最新的lsn，从上一次检查点重放
保证数据库不丢数据
是如何恢复的
重放xlog从磁盘到wal buffer ，redo poin它中有lsn号，去和shared buffer中的lsn做对比，大的就回放
块折断
full_page_writes作用：是否开启全页写入，为了防止块折断（块损坏）的一种策略
判断：checksum值
采用机制：在checkponit后的一个块第一次变脏后就要整块写入到wal日志中，
后续修改这个块，只要把修改信息写入到wal日志
断电重启，有块折断，
则在全页写入的块为基础进行恢复
最后覆盖磁盘上的折断块
参数checkpoint_segments对checkpoint影响
作用：控制checkpoint的间隔
过大：恢复时间会变长	
过小：造成频繁的checkpoint进而导致写入了过多的全页，可能wal日志暴增
检查点作用
1.将事务提交的修改写进disk（写脏数据）；保证数据库的完整性和一致性。
2.缩短恢复时间,将脏页写入相应的数据文件,确保修改后的文件通过fsync()写入到磁盘。
触发条件：
1、checkpoint_timeout设置时间
2、为checkpoint_segments设置的 WAL 段文件的数量自上一个检查点以来已经被消耗（默认3）
3、WAL 段文件的总大小已超过参数max_wal_size的值（默认值为 1GB（64 个文件））
4、PostgreSQL 服务器在smart或fast模式下停止
5、手动执行CHECKPOINT
6、写入WAL的数据量已达到参数max_wal_size（默认值：1GB）
7、执行pg_start_backup函数时
8、在进行数据库配置时</p> <p>pg_control文件
包含检查点的基本信息，如果损坏或无法读取，则无法启动恢复过程，从而无法获得起点。</p> <p>WAL段切换
1、wal段文件被写满
2、函数pg_switch——wal()被调用
3、启用了archive_mode,且已经超过archive_timeout配置的超时时间。
archive_timeout时间短会导致空间膨胀</p> <h1 id="_15、postgresql中lock-timeout设置"><a href="#_15、postgresql中lock-timeout设置" class="header-anchor">#</a> 15、postgresql中lock_timeout设置</h1> <p>设置为10s</p> <p>session1：测试插入更新数据</p> <p><img src="/image//clip_/image002.jpg" alt="img"></p> <p>session2:同时更新事务一中的数据，锁超时事务被杀掉</p> <p><img src="/image//clip_/image004.jpg" alt="img"></p> <p>继续在seasion2中操作会报错</p> <p><img src="/image//clip_/image006.jpg" alt="img"></p> <p>session2选择rollback或者commit</p> <p>rollback回滚当前事务，commit提交报错之前执行的操作</p> <p>session1执行commit提交成功；</p> <p><img src="/image//clip_/image008.jpg" alt="img"></p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/08/10, 19:06:03</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/dbb18f/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">查找消耗高SQL以及SQL优化</div></a> <a href="/note/sql/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">《sql编程》笔记</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/dbb18f/" class="prev">查找消耗高SQL以及SQL优化</a></span> <span class="next"><a href="/note/sql/">《sql编程》笔记</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/65ef88/"><div>
            脑图测试
            <!----></div></a> <span class="date">08-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/8bf37a/"><div>
            测试
            <!----></div></a> <span class="date">08-07</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/66aff8/"><div>
            nginx文件配置
            <!----></div></a> <span class="date">07-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:473618849@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.be07e937.js" defer></script><script src="/assets/js/2.421bd99f.js" defer></script><script src="/assets/js/3.52061743.js" defer></script><script src="/assets/js/23.b75d31d7.js" defer></script>
  </body>
</html>
