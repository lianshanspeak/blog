---
title: python_ansible自动化运维3
date: 2023-01-07 18:22:34
permalink: /pages/0049a6/
categories:
  - 编程
  - python
tags:
  - 
---
# 涉及ansible相关

## 自动化任务的执行

![image-20230108104506044](./image/image-20230108104506044.png)

什么是自动化任务

![image-20230108104545976](./image/image-20230108104545976.png)

![image-20230108104620512](./image/image-20230108104620512.png)

![image-20230108104710136](./image/image-20230108104710136.png)



![image-20230108104725694](./image/image-20230108104725694.png)

![image-20230108104735910](./image/image-20230108104735910.png)

展示效果

![image-20230108104757498](./image/image-20230108104757498.png)

## ansible基础和安装

![image-20230108104859331](./image/image-20230108104859331.png)

![image-20230108105000286](./image/image-20230108105000286.png)

![image-20230108105040581](./image/image-20230108105040581.png)

下载指定包，上github

![image-20230108105132567](./image/image-20230108105132567.png)

解压之后安装

![image-20230108105201973](./image/image-20230108105201973.png)

检测ansible是否安装好

![image-20230108105310937](./image/image-20230108105310937.png)

## ansible的配置文件

![image-20230108105413583](./image/image-20230108105413583.png)

修改配置文件路径，这里不用修改

![image-20230108105550034](./image/image-20230108105550034.png)

没有ansible目录的话手动新建一个，并配置cfg文件

![image-20230108105735748](./image/image-20230108105735748.png)

ansible.cfg文件内容，inventory 获取主机清单

![image-20230108105755131](./image/image-20230108105755131.png)

ansible读取配置文件先后顺序

![image-20230108105918571](./image/image-20230108105918571.png)

ansible常用配置项

![image-20230108155001238](./image/image-20230108155001238.png)

yaml配置语法

cfg配置文件讲解，更多的可以去官网查询

![image-20230108155124481](./image/image-20230108155124481.png)

![image-20230108155309899](./image/image-20230108155309899.png)

配置方式

![image-20230108155348275](./image/image-20230108155348275.png)

![image-20230108155400174](./image/image-20230108155400174.png)

![image-20230108155421332](./image/image-20230108155421332.png)

列出host文件所有主机

![image-20230108155622658](./image/image-20230108155622658.png)



![image-20230108155711562](./image/image-20230108155711562.png)

密码登录场景

![image-20230108155806443](./image/image-20230108155806443.png)

测试的相关配置文件

![image-20230108155833459](./image/image-20230108155833459.png)

主机资产配置hosts

![image-20230108155856740](./image/image-20230108155856740.png)



![image-20230108160106620](./image/image-20230108160106620.png)

在ansible服务器上生成公钥私钥

![image-20230108160156058](./image/image-20230108160156058.png)

把公钥拷贝到需要连接的服务器

![image-20230108160237278](./image/image-20230108160237278.png)

模拟登录就不需要输入密码了

在主机清单可以这样配置了

![image-20230108160331532](./image/image-20230108160331532.png)

或者在ansible.cfg里面有个默认配置，就不需要主机清单配置了，下面写个绝对路径，截图是相对路径

![image-20230108160450890](./image/image-20230108160450890.png)



![image-20230108160540086](./image/image-20230108160540086.png)



## ansible的ad-hoc模式

![image-20230108160632609](./image/image-20230108160632609.png)

![image-20230108160646824](./image/image-20230108160646824.png)

![image-20230108160819442](./image/image-20230108160819442.png)

![image-20230108160851083](./image/image-20230108160851083.png)

![image-20230108160935139](./image/image-20230108160935139.png)

-f 多少并发进行

![image-20230108161040276](./image/image-20230108161040276.png)

指定主机

![image-20230108161205919](./image/image-20230108161205919.png)

代码部署，拉取代码进行部署

要求目标机器上需要有git工具

repo代码路径，version版本dest目标机器放在哪个路径

![image-20230108161441128](./image/image-20230108161441128.png)

## ansible_palybook

![image-20230108161645713](./image/image-20230108161645713.png)

![image-20230108161759176](./image/image-20230108161759176.png)

![image-20230108161806268](./image/image-20230108161806268.png)

![image-20230108161835287](./image/image-20230108161835287.png)

![image-20230108161919488](./image/image-20230108161919488.png)

![image-20230108161927647](./image/image-20230108161927647.png)



![image-20230108162012215](./image/image-20230108162012215.png)

![image-20230108162113360](./image/image-20230108162113360-16731660736402.png)

![image-20230108162132039](./image/image-20230108162132039.png)

playbook检查在哪些机器上执行，不用--list-hosts就没有

![image-20230108162239959](./image/image-20230108162239959.png)

### yaml语法规则

![image-20230108162530568](./image/image-20230108162530568.png)

![image-20230108162540448](./image/image-20230108162540448.png)

![image-20230108162554718](./image/image-20230108162554718.png)

\t是tab的制表符，yaml中警惕按了tab

![image-20230108162745463](./image/image-20230108162745463.png)

### 通过选项方式传递变量

![image-20230108162823471](./image/image-20230108162823471.png)

![image-20230108162839390](./image/image-20230108162839390.png)

![image-20230108162910105](./image/image-20230108162910105.png)

### 通过文件进行变量定义

![image-20230108162948089](./image/image-20230108162948089.png)



### 注册变量

register

![image-20230108163035259](./image/image-20230108163035259.png)

![image-20230108163159176](./image/image-20230108163159176.png)

![image-20230108163222822](./image/image-20230108163222822.png)

playbook基本语句

### 条件语句

when的使用

![image-20230108163301118](./image/image-20230108163301118.png)

返回结果

![image-20230108163503509](./image/image-20230108163503509.png)

### 循环语句

**![image-20230108163516649](./image/image-20230108163516649.png)**

![image-20230108163529640](./image/image-20230108163529640.png)

with_item接的是列表，列表1，列表2

![image-20230108163615085](./image/image-20230108163615085.png)

字典方式

![image-20230108163918914](./image/image-20230108163918914.png)

相对路径，本地拷贝aa/下的到目标机器/tmp/bb下面去，目标机器需要有这么目录

![image-20230108164013278](./image/image-20230108164013278.png)



复合使用

先做循环，里面加上条件判断，后面在执行debug输出任务

![image-20230108164247570](./image/image-20230108164247570.png)

### 异常处理和tags

![image-20230108164631944](./image/image-20230108164631944.png)

![image-20230108164643479](./image/image-20230108164643479.png)

ignore_errors

![image-20230108164720982](./image/image-20230108164720982.png)

自定义错误failed_when

![image-20230108164850572](./image/image-20230108164850572.png)

关闭change黄色状态

![image-20230108165148876](./image/image-20230108165148876.png)

tag标签，标签打到后面

![image-20230108165203925](./image/image-20230108165203925.png)

![image-20230108165301964](./image/image-20230108165301964.png)

![image-20230108165342724](./image/image-20230108165342724.png)

只对一个标签进行处理

![image-20230108165425580](./image/image-20230108165425580.png)

## roles角色和场景演练

![image-20230108165521922](./image/image-20230108165521922.png)

![image-20230108165631445](./image/image-20230108165631445.png)

![image-20230108165747947](./image/image-20230108165747947.png)

上面是把复杂剧本进行拆分

讲解视频6-24

roles可以独立的类型

![image-20230108165905652](./image/image-20230108165905652.png)

![image-20230108165913267](./image/image-20230108165913267.png)

### roles设计思路

![image-20230108170428860](./image/image-20230108170428860.png)

![image-20230108170444428](./image/image-20230108170444428.png)

场景演练

![image-20230108170519891](./image/image-20230108170519891.png)

![image-20230108170535362](./image/image-20230108170535362.png)

![image-20230108170549116](./image/image-20230108170549116.png)

![image-20230108170604226](./image/image-20230108170604226.png)

![image-20230108170610220](./image/image-20230108170610220.png)

webserver.yml为主剧本

![image-20230108170721671](./image/image-20230108170721671.png)

![image-20230108170747459](./image/image-20230108170747459.png)

![image-20230108170820368](./image/image-20230108170820368.png)

notify执行了之后就触发了

![image-20230108171000913](./image/image-20230108171000913.png)

![image-20230108171008227](./image/image-20230108171008227.png)

![image-20230108171033673](./image/image-20230108171033673.png)

讲解在6-26

![image-20230108171136309](./image/image-20230108171136309.png)

![image-20230108171322277](./image/image-20230108171322277.png)

notify收到重启的信息，马上到handlers里面去找































